<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>eXO - Social freedom</title>
  <!-- Favicon -->
  <link rel="shortcut icon" href="/site_media/images/favicon.ico" type="image/x-icon" />

  <!-- Stylesheets -->
  <link href="/site_media/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/site_media/stylesheets/print.css" media="print" rel="stylesheet" type="text/css" />
  <!--[if lt IE 8]>
      <link href="/site_media/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <![endif]-->
  <link media="screen, projection" href="/site_media/stylesheets/base.css" type="text/css" rel="stylesheet" />
  <link media="screen, projection" href="/site_media/stylesheets/fileuploader.css" type="text/css" rel="stylesheet" />

  <!-- Javascripts -->
  <script type="text/javascript" src="/site_media/javascripts/jquery-1.4.3.min.js"></script>
  <script type="text/javascript" src="/site_media/javascripts/sammy/sammy.js" charset="utf-8"></script>
  <script type="text/javascript" src="/site_media/javascripts/sammy/plugins/sammy.mustache.js" charset="utf-8"></script>
  <script type="text/javascript" src="/site_media/javascripts/fileuploader.js"></script>
  <script type="text/javascript">

  function start_polling(reqID, url, redirect_callback){
    $.ajax({
      type: 'POST',
      url: url,
      data: {eXO_data: JSON.stringify({"eXO::reqID" : reqID})},
      success: function(data){
        polling_callback(data, reqID, url, redirect_callback);
        return true;
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        alert("An error occurred : "+textStatus);
        return false;
      }
    });
  }
  function polling_callback(polling_data, reqID, url, redirect_callback){
    if("eXO::Status" in polling_data){
      if(polling_data["eXO::Status"]=="eXO::Processing"){
        // Continue polling after 100ms
        setTimeout(function(){ start_polling(reqID, url, redirect_callback); }, 100);
        return true;
      } else {
        if (polling_data["eXO::Status"]=="eXO::Success"){
          // TODO: Notify about success
          redirect_callback();
        } else if (polling_data["eXO::Status"]=="eXO::Unknown"){
          // TODO: Fill in with general notification message
        } else {
          // TODO: Fill in with general notification message
        }
      }
      // TODO: On stop of processing trigger other events
      return true;
    }
  }

  var app = $.sammy('#content-main', function() {
    // include the plugin and alias mustache() to ms()
    this.use(Sammy.Mustache, 'ms');

    this.post('#/file_index/delete/', function() {
    });
    this.get('#/file_list/get/', function() {
      var context = this;
      $.ajax({
        type: 'POST',
        url: "/servlet/GetContent/",
        dataType: 'json',
        data: "",
        success: function(data){
          // TODO: Do template rendering
          if("eXO::Status" in data && data["eXO::Status"]=="eXO::Success"){
            // Refactor the fetched data dictionary
            var templ = { "profiles": [] };
            var counter = 0;
            for(id in data["eXO::Data"]){
              templ["profiles"][counter] = data["eXO::Data"][id];
              templ["profiles"][counter]["counter"] = counter;
              templ["profiles"][counter]["file_id"] = id;
              templ["profiles"][counter]["zebra"] = function(){
                return (this.counter%2==0?"even-row":"odd-row");
              };
              counter++;
            }
            //Sammy.log(templ);
            context.render("/site_media/templates/file_list.ms", templ,
             function(content){
              $('#file-list').html(content).hide();
              // Bind events here
              $(".show").toggle(function(){
                $(this).parents(".file-row").find(".tags-wrapper").show();
                $(this).text("Hide");
                return false;
              },function(){
                $(this).parents(".file-row").find(".tags-wrapper").hide();
                $(this).text("Show");
                return false;
              });
              $(".file-data ").hover(function(){
                $(".actions-wrapper", this).show();
              },function(){
                $(".actions-wrapper", this).hide();
              });
              setTimeout(function(){ 
                $("#content-main-loading").hide();
                $('#file-list').show();
              }, 500);
            });
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          alert("An error occurred : "+textStatus);
        }
      });
    });
    this.get('#/file_profile/get/', function() {
    });
    this.post('#/file_profile/set/', function() {
    });
  });

  $(function (){
    // Show/hide the Loading indicator
    $("#loading-indicator").ajaxStart(function(){
       $(this).show();
    }).ajaxStop(function(){
      var indicator = $(this);
      setTimeout(function(){ indicator.fadeOut() }, 500);
    });
    
    // Get username and resource
    $.ajax({
      type: 'POST',
      url: "/servlet/GetUserProfile/",
      dataType: 'json',
      data: "",
      success: function(data){
        if("eXO::Status" in data && data["eXO::Status"]!="eXO::Success"){
          alert("Failed to access user profile data!");
          return false;
        }
        profile_dict = data["eXO::Data"]["eXO::Profile"];
        // Fill in the data to the corresponding places
        var username="Incognito", resource="Home";
        for(dict in profile_dict){
          if(profile_dict[dict]["eXO::FieldName"]=="Username"){
            username = profile_dict[dict]["eXO::FieldData"];
          }else if(profile_dict[dict]["eXO::FieldName"]=="Resource"){
            resource = profile_dict[dict]["eXO::FieldData"];
          }
        }
        if(username!=null)
          $("#username").html(username);
        if(resource!=null)
          $("#resource").html(resource);
      },
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        alert("An error occurred : "+textStatus);
      }
    });

    /* Bind ajax upload button */
    var uploader = new qq.FileUploader({
      element: $('#upload-element')[0],
      action: "/servlet/ShareFile/",
      responseType: "json",
      onComplete : function(id, file, data) {
        // Poll till success
        // Rerender profiles and rebind events
        if("eXO::reqID" in data){
          start_polling(data["eXO::reqID"], "/servlet/ShareFile/", function(){
            // Here we define the redirection callback!
            app.runRoute("get", "#/file_list/get/");
          });
          return true;
        } else {
          alert("Failed to upload file!");
          return false;
        }
      }
    });

    // Run sammy application
    app.run('#/file_list/get/');
  });
  </script>
</head>

<body>

  <div id="loading-indicator">
    <div class="i16 waiting" onClick="$('#loading-indicator').slideUp()">
    loading ...
    </div>
  </div>

  <div id="header-wrapper" >
    <div id="header-container" class="container">

      <div id="userbox">
        <!--
        <div id="avatar-wrapper">
        <img height="20" width="20" alt="" src="/site_media/images/generic.jpg">
        </div>
        -->
        <ul class="horizontal">
          <li>Account Settings</li>
          <li>Logout</li>
        </ul>
      </div>
      <div id="logo" class="span-10">
        <a href="/">eXO<sup>beta</sup></a>
        <span> The Decentralized Social Network</span>
      </div>
      <div id="global-menu" class="span-16 last">
        <ul class="horizontal">
          <li><a href="#">Network Status</a></li>
          <li><a href="#">About</a></li>
          <li><a href="#">Help</a></li>
        </ul>
      </div>
    </div><!-- END HEADER-CONTAINER -->
  </div><!-- END HEADER-WRAPPER -->

  <div id="middle-wrapper">
    <div id="middle-container" class="container">
      <div id="breadcrumb" class="span-26"></div>

      <div id="content-header-wrapper" class="container">
      <div id="content-header">
        <div id="content_title" class="span-16">
          <h2>
            <img height="50" width="50" alt="" src="/site_media/images/generic.jpg">
            <span id="username">Incognito</span>
            <span id="at">/</span>
            <span id="resource">Home</span>
          </h2>
        </div>
        <div id="content_nav" class="span-10 last">
          <ul class="horizontal">
            <li>
              <a href="/">My Profile</a>
            </li>
            <li>
              <a href="/search">Search</a>
            </li>
            <li class="current">
              <a href="/content">Share Content</a>
            </li>
            <li>
              <a href="#">Friends</a>
            </li>
          </ul>
        </div>
      </div>
      </div>

      <div id="content-main" class="span-26">
        <div id="upload-body" class="content-body">
          <h2>File upload</h2>
          <div id="upload-wrapper">
            <div id="upload-element"></div>
          </div>
          <div id="file-list-wrapper" class="clear">
            <div id="file-list"> 
            </div>
            <div id="content-main-loading">
              <p>
                <img src="/site_media/images/loading.gif" />
              </p>
              <p>Loading Content</p>
            </div>
          </div>
        </div>
      </div>

      <div id="content_footer" class="span-26"></div>

    </div><!-- END MIDDLE-CONTAINER -->
  </div><!-- END MIDDLE-WRAPPER -->

  <div id="footer-wrapper">
    <div id="footer-container" class="container">
        <div class="span-6">
          <ul>
            <li class="title">Service</li>
            <li>Privacy Policy</li>
            <li>Terms of Service</li>
          </ul>
        </div>
        <div class="span-6">
          <ul>
            <li class="title">Resources</li>
            <li>FAQ</li>
            <li>API Documentation</li>
          </ul>
        </div>
        <div class="span-6 last">
          <ul>
            <li class="title">About</li>
            <li>Team</li>
            <li>Follow us on Twitter</li>
            <li>Blog</li>
          </ul>
        </div>
    </div>
  </div>

</body>
</html>
